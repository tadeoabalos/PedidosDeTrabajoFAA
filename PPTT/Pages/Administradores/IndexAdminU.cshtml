@page
@model PPTT.Pages.Administradores.IndexAdminUModel
@using Microsoft.AspNetCore.Mvc.RazorPages
@using PPTT.Data

@{
    ViewData["Title"] = "ABM usuario";    
    var servicios = HttpContext.Session.GetObject<Dictionary<int, string>>("Servicios");

    
    if (servicios != null)
    {
        foreach (var kvp in servicios)
        {
            Console.WriteLine($"Key: {kvp.Key}, Value: {kvp.Value}");
        }
    }
    else
    {
        Console.WriteLine("No se encontraron servicios en la sesión.");
    }
}
<div class="header-index-pt">
    <a class="btn-header-pt" asp-page="Create">Crear Nuevo Usuario</a>
    <form method="get">
        <input class="buscador" type="text" name="searchQuery" placeholder="Busca por Nombre, Apellido, DNI o Correo." value="@Model.SearchQuery" />
        <button type="submit" class="filtrar">Buscar</button>
    </form>
    <button id="btnExportar" class="btnExportar">Exportar Excel</button>
</div>

<table class="table" id="tabla">
    <thead>
        <tr>
            <th>@Html.DisplayNameFor(model => model.Admin[0].Nombre)</th>
            <th>@Html.DisplayNameFor(model => model.Admin[0].Apellido)</th>
            <th>@Html.DisplayNameFor(model => model.Admin[0].DNI)</th>
            <th>@Html.DisplayNameFor(model => model.Admin[0].Numero_Control)</th>
            <th>@Html.DisplayNameFor(model => model.Admin[0].Correo)</th>            
            <th>@Html.DisplayNameFor(model => model.Admin[0].ID_Servicio_Fk)</th>
            <th>@Html.DisplayNameFor(model => model.Admin[0].Fecha_Alta)</th>
            <th>@Html.DisplayNameFor(model => model.Admin[0].Fecha_Baja)</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @{
            var divisionUsuario = HttpContext.Session.GetInt32("Division");
            var divisionUsuario2 = HttpContext.Session.GetInt32("Division2");
        }
        @foreach (var item in Model.Admin)
        {
            @if (item.ID_Division_Fk == divisionUsuario || item.ID_Division_Fk == divisionUsuario2)
            {
            <tr>
                <td>@item.Nombre</td>
                <td>@item.Apellido</td>
                <td>@item.DNI</td>
                <td>@item.Numero_Control</td>
                <td>@item.Correo</td>
                @if (item.ID_Division_Fk == null)
                {
                    @:No se le asignó una división
                }
                else if (Model.Divisiones != null)
                {
                    var division = Model.Divisiones.FirstOrDefault(d => d.ID_Division_Pk == item.ID_Division_Fk);
                    if (division != null)
                    {
                        @division.Descripcion_Division
                    }
                    else
                    {
                        @:División desconocida
                    }
                }
                <td>
                    @if (item.ID_Servicio_Fk == null)
                    {
                        @:No se le asignó un servicio
                    }
                    else if (servicios != null && servicios.ContainsKey(item.ID_Servicio_Fk.Value))
                    {
                        @servicios[item.ID_Servicio_Fk.Value]
                    }
                    else
                    {
                        @:Servicio no reconocido
                    }
                </td>
                <td>@item.Fecha_Alta?.ToShortDateString()</td>
                <td>
                    @if (item.Fecha_Baja?.ToShortDateString() == "1/1/0001")
                    {
                        @:--/--
                    }
                    else
                    {
                        @item.Fecha_Baja?.ToShortDateString()
                    }
                </td>
                <td>
                    @if (item.Fecha_Baja?.ToShortDateString() == "1/1/0001")
                    {
                        <div class="lista-seccion-boton">
                            <a asp-page="./Details" asp-route-id="@item.ID_Usuario_Pk">Detalle</a>
                            |
                            <a asp-page="./Edit" asp-route-id="@item.ID_Usuario_Pk">Modificar</a>
                            |
                            <a asp-page="./Delete" asp-route-id="@item.ID_Usuario_Pk">Dar de baja</a>
                        </div>
                    }
                    else
                    {
                        <div class="lista-seccion-boton">
                            <a asp-page="./AltaDenuevo" asp-route-id="@item.ID_Usuario_Pk">Dar de Alta</a>
                        </div>
                    }
                </td>
            </tr>
            }
        }
    </tbody>
</table>

<!-- Scripts para exportar a Excel -->
<script src="https://unpkg.com/xlsx@0.16.9/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/file-saverjs@latest/FileSaver.min.js"></script>
<script src="https://unpkg.com/tableexport@latest/dist/js/tableexport.min.js"></script>

<!-- Script para exportar a Excel -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const $btnExportar = document.querySelector("#btnExportar"),
            $tabla = document.querySelector("#tabla");

        $btnExportar.addEventListener("click", function () {
            let tableExport = new TableExport($tabla, {
                exportButtons: false, 
                filename: "Reporte de Usuarios", 
                sheetname: "Usuarios", 
                ignoreCols: [9] 
            });

            let datos = tableExport.getExportData();
            let preferenciasDocumento = datos.tabla.xlsx;

            tableExport.export2file(
                preferenciasDocumento.data,
                preferenciasDocumento.mimeType,
                preferenciasDocumento.filename,
                preferenciasDocumento.fileExtension,
                preferenciasDocumento.merges,
                preferenciasDocumento.RTL,
                preferenciasDocumento.sheetname
            );
        });
    });
</script>
